---
description: Project overview, architecture, and conventions for DaggerheartGM
alwaysApply: true
---

# DaggerheartGM

A GM tool for the Daggerheart tabletop RPG. Built as a Node.js/Express server that serves a self-contained SPA.

## Architecture

- `server.js` — Express server entry point. Serves static files from `public/` and falls back to `public/index.html` for any unmatched route (standard SPA behavior). API routes live here. On startup, runs DB migrations if `DATABASE_URL` is set.
- `src/client/app.jsx` — React SPA entry point. Imports from `./lib/api.js`, mounts via `ReactDOM.createRoot`. Manages top-level state (data, activeElements, user). Uses `useRouter()` from `./lib/router.js` to derive the active view from the URL; all navigation calls `navigate()` so the browser back/forward buttons work. The nav bar user menu (click your name/email) provides Export JSON, Import JSON, and Sign Out. Persists `whiteboardEmbed`, `rolzRoomName`, `rolzUsername`, and `rolzPassword` in the `table_state` collection alongside `activeElements`.
- `src/client/components/` — UI components: `LibraryView.jsx`, `GMTableView.jsx`, `NavBtn.jsx`, `ItemCard.jsx`, `ItemDetailView.jsx`, `RolzRoomLog.jsx`.
- `src/client/components/forms/` — Item creation/edit forms: `AdversaryForm`, `EnvironmentForm`, `GroupForm`, `SceneForm`, `AdventureForm`, plus shared inputs `ExperiencesInput`, `FeaturesInput`, `FormRow`, `MultiSelectRef`. Also `FeatureLibrary.jsx` — a sidebar panel rendered inside `AdversaryForm`/`EnvironmentForm` (when `allItems` prop is provided) that shows deduplicated features from same-tier, same-subtype items sorted by source (own/srd/public), with hover-to-detail and click-to-add.
- `src/client/components/modals/` — Import modals: `RolzImportModal.jsx`, `FCGImportModal.jsx`. Shared utilities in `ImportModalShell.jsx` and `ImportPreviewCard.jsx`. Inline editing modals: `EditChoiceDialog.jsx` (asks "Edit Copy" vs "Edit Library Original"), `EditFormModal.jsx` (modal wrapper around `AdversaryForm`/`EnvironmentForm`).
- `src/client/lib/` — Client-side utilities: `api.js` (Firebase init + fetch helpers + `postRolzRoll` + `fetchRolzRoomLog`), `helpers.js` (`generateId`), `constants.js`, `rolz-parser.js`, `rolz-export.js`, `router.js` (History API router: `useRouter()` hook + `parseRoute()`).
- `src/db.js` — Postgres connection pool, migration runner, and query helpers (`getItems`, `getSrdItems`, `getPublicItems`, `upsertItem`, `deleteItem`). Exports `SRD_USER_ID = '__SRD__'`.
- `src/fcg-scraper.js` — Puppeteer-based scraper for FreshCutGrass.app homebrew pages. Exports `validateFCGUrl(url)` and `scrapeFCG(url)`. Launches headless Chrome, clicks each adversary card to open its detail modal, and returns `{ adversaries, environments }` shaped for import.
- `src/input.css` — Tailwind CSS entry point (`@import "tailwindcss"`). Tailwind v4 scans `public/**/*.{html,jsx}` and `src/client/**/*.jsx` automatically.
- `migrations/` — Numbered `.sql` migration files (e.g. `001_create_items_table.sql`). Applied automatically at startup via `src/db.js`. Add new files here to evolve the schema. `002_add_is_public.sql` adds the `is_public BOOLEAN` column.
- `scripts/fetch-srd.js` — Fetches pre-built adversary/environment JSON from `seansbox/daggerheart-srd` on GitHub, transforms to app schema, writes to `data/srd-adversaries.json` and `data/srd-environments.json`. Run with `npm run fetch:srd`.
- `scripts/seed-srd.js` — Reads `data/srd-*.json` and upserts them into the DB with `user_id='__SRD__'` and `is_public=true`. Run with `npm run seed:srd`.
- `data/` — Generated JSON output from `scripts/fetch-srd.js`. Not committed to git.
- `public/index.html` — Thin HTML shell. Links to the locally-built `public/styles.css`, loads Babel standalone and an ES importmap (pointing to esm.sh CDN for React 18, Firebase 10, Lucide React). Loads the app via `<script type="module" src="/app.js">`.
- `public/styles.css` — Generated Tailwind CSS output. Do **not** edit by hand; rebuild with `npm run build:css`.
- `public/` — All static assets (images, fonts, compiled JS, etc.) go here.
- `package.json` — Uses ES modules (`"type": "module"`). Dependencies: `express`, `pg`, `firebase-admin`, `puppeteer`. Dev dependencies: `tailwindcss`, `@tailwindcss/cli`.

## Database

Supabase Postgres (or any Postgres). Set `DATABASE_URL` in `.env` to the connection string (URI format). Migrations run automatically on server start.

Schema uses a single `items` table:
- `(app_id, collection, id)` — composite primary key
- `user_id` — Firebase UID; all queries are scoped per user. Special value `__SRD__` for SRD content.
- `data` — JSONB blob storing the full entity
- `app_id` — from `APP_ID` env var; namespaces data per deployment
- `is_public` — boolean; when true, item is visible to all authenticated users (always true for SRD items)

## API Routes

- `GET /api/config` — Returns `{ firebaseConfig }` (no auth required). Consumed by `app.jsx` at startup.
- `GET /api/data?includeSrd=1&includePublic=1` — Returns `{ adversaries, environments, groups, scenes, adventures }` for the authenticated user. Optional query params `includeSrd=1` and `includePublic=1` merge in SRD content and other users' public items respectively. Items include `_source` ('own' | 'srd' | 'public') and `_owner` (user_id for public items).
- `PUT /api/data/:collection` — Upsert an item (body is the item JSON). Respects `is_public` field. Returns the saved item.
- `DELETE /api/data/:collection/:id` — Delete an item.
- `GET /api/fetch-fcg?url=<fcg-url>` — Requires auth. Uses Puppeteer to scrape a FreshCutGrass.app homebrew page and returns `{ adversaries, environments }` ready for import. URL must start with `https://freshcutgrass.app/homebrew/`. Takes 20–40 seconds.
- `GET /api/rolz-roomlog?room=NAME` — Requires auth. Proxies the Rolz room log feed (`https://rolz.org/api/roomlog`). Returns `{ room, items }` with message history. Polled by `RolzRoomLog` component every 5 seconds.
- `POST /api/rolz-post` — Requires auth. Body: `{ room, text, from, rolzUsername, rolzPassword }`. Logs into Rolz.org with the provided credentials (server-side session cache keyed by Firebase UID, TTL 30 min), then proxies the roll post to `https://rolz.org/api/post` with the session cookie forwarded. On "Invalid account name" response, invalidates the cache and retries once with a fresh login. Returns the Rolz JSON response.

All `/api/data` routes require an `Authorization: Bearer <Firebase ID token>` header. The server verifies the token via `firebase-admin` (uses `FIREBASE_PROJECT_ID`; no service account key needed).

## Node / nvm

Node is managed via nvm. The active binary is at:

```
/Users/andrewreutter/.nvm/versions/node/v25.2.1/bin/node
```

When running `node`, `npm`, or `nvm` commands in a shell that may not have sourced `.bashrc`/`.zshrc`, use the full path or prepend the bin directory:

```bash
export PATH="/Users/andrewreutter/.nvm/versions/node/v25.2.1/bin:$PATH"
```

## Running the App

```bash
npm install         # first time only
npm run build:css   # (re)generate public/styles.css from src/input.css
npm run dev         # development: starts server (--watch) + Tailwind watcher in parallel
npm start           # production (run npm run build:css first if styles changed)
npm run fetch:srd   # fetch SRD data from GitHub -> data/srd-adversaries.json + data/srd-environments.json
npm run seed:srd    # seed data/ into DB with user_id='__SRD__' (requires DATABASE_URL)
```

Server listens on `process.env.PORT` or `3456` by default. Set `PORT` in `.env` to override — both `npm start` and `npm run dev` load `.env` automatically via `node --env-file=.env`.

## Rolz.org Dice Room Integration

The "Game Table" tab shows two side-by-side panels (70/30 split): the Zoom whiteboard (iframe embed) on the left, and a **Rolz room log** panel on the right. A collapsible "Configure Embeds" bar at the top contains inputs for both.

**Room Log** (`RolzRoomLog.jsx`): A custom chat-style display of the dice room log, replacing the Rolz iframe (which cannot maintain login due to third-party cookie restrictions). Polls `GET /api/rolz-roomlog` every 5 seconds. Renders four message types (`txtmsg`, `dicemsg`, `srvmsg`, `timeinfo`) with distinct styling. Dice messages highlight roll expressions in yellow and results in green. Auto-scrolls to bottom on new messages (preserves scroll position if user has scrolled up). Header includes a refresh button and an "open in new tab" link to the full Rolz dice room.

**Configuration** (persisted in `table_state`):
- `rolzRoomName` — drives the room log feed, the "open in new tab" link, and is used as the `room` parameter when posting rolls
- `rolzUsername` / `rolzPassword` — Rolz.org credentials used by the server to obtain a session cookie for API posting

**Clickable dice rolls**: When room name + Rolz credentials are all configured, attack actions become clickable:
- **Actions Board** (left sidebar): clicking an attack card posts the roll to the Rolz room via `POST /api/rolz-post` and briefly flashes green
- **GM Table adversary cards**: the Attack line and action-type features with attack patterns show a dice icon and post a roll when clicked
- Rolls are formatted as: `{sourceName} {attackName} [d20+{modifier}] damage [{damage} {trait}] {range}`
- Only primary attacks and action-type features matching the attack description pattern (`+N Range | Xd6 trait`) are made rollable
- Clicking an attack when not fully configured navigates to the Game Table tab and opens the config panel with a hint

To enable posting: in the Rolz dice room, type `/room api=on`. Enter your Rolz username and password in the Configure Embeds panel. The server caches the session cookie in memory (30-minute TTL) to avoid repeated logins.

## Inline Editing (Scenes, Groups, GM Table)

Adversaries and environments can be edited directly from the context where they appear:

- **GM Table**: A pencil button on each card opens `EditChoiceDialog` → then `EditFormModal`. "Edit Table Copy" updates only the active element in memory (preserving HP/stress). "Edit Library Original" saves to the DB and refreshes all matching active elements.
- **Scene / Group detail view**: Each expanded card in `ExpandedTablePreview` has a pencil button. Same two-choice dialog. "Edit Copy" converts the reference to an inline owned copy stored in the parent scene/group. "Edit Library Original" saves to the DB.
- SRD and public items are forced into "Edit Copy" mode (no "Edit Library Original" option).

### Polymorphic data model (Scenes and Groups)

Groups and Scenes store adversaries/environments as either ID references or inline owned copies:

```js
// Group adversaries:
adversaries: [
  { adversaryId: "abc", count: 3 },           // reference
  { data: { name: "Custom Goblin", ... }, count: 2 } // owned copy
]
// Scene adversaries — same shape
// Scene environments:
environments: [
  "env-123",                                   // reference (string ID)
  { data: { name: "Custom Forest", ... } }     // owned copy
]
// Scene groupOverrides — suppresses a group adversary so a scene-level copy takes over:
groupOverrides: [{ groupId: "group-1", adversaryId: "goblin-id" }]
```

`GroupForm` and `SceneForm` preserve owned copies through edits (they appear in a read-only "Local Copies" section). Owned copies are rendered with an amber "local copy" badge in `ExpandedTablePreview` and with amber chips in `ItemCard`.

## Conventions

- API routes: add `app.get/post/...('/api/...')` handlers in `server.js` before the static middleware.
- Static assets: place in `public/`.
- ES modules (`import`/`export`) throughout — no `require()`.
- Routing: use `useRouter()` / `navigate()` from `src/client/lib/router.js` for all view transitions. URL scheme: `/` (home/sign-in), `/library/:tab`, `/library/:tab/new`, `/library/:tab/:id`, `/library/:tab/:id/edit`, `/gm-table`.

## Maintaining Documentation

Whenever you make structural changes to this project — adding or removing files/directories, introducing new dependencies, establishing new conventions, changing UI layout, or adding API routes — you **must** update **both** of the following as a mandatory step in every plan:

1. **`.cursor/rules/project.mdc`** (this file) — keep the architecture bullets, API routes, and conventions accurate.
2. **`README.md`** — keep the directory tree and architecture description in sync.

This is not optional or an afterthought. Every plan that touches project structure must include a dedicated "Update documentation" step covering both files.
